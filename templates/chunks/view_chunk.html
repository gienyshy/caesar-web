{% extends "base.html" %}

{% block extrahead %}

<link rel="stylesheet" href="{{ STATIC_URL }}css/chunks.css" type="text/css" />
<link rel="stylesheet" href="{{ STATIC_URL }}css/comments.css" type="text/css" />

<script type="text/javascript">
var chunkId = {{ chunk.id }};

$(document).ready(function() {

var commentBoundaries = $('.comment').map(function() {
    var idSplit = this.id.split('-');
    return { id: parseInt(idSplit[1]), 
             start: parseInt(idSplit[2]), 
             end: parseInt(idSplit[3]),
             elt: this };
});

function showCommentForm(startLine, endLine) {
    $.get('{% url caesar.comments.views.new %}', 
        { start: startLine, end: endLine, chunk: chunkId },
        function(data) {
            $('.comment-form').remove();
            // find the appropriate place to insert the form
            var added = false;
            $.each(commentBoundaries, function(index, comment) {
                if ((startLine == comment.start && endLine <= comment.end)
                    || startLine < comment.start) {
                    $(comment.elt).before(data);                        
                    added = true;
                    return false;
                }
            });
            if (!added) {
                $('#comment-display').append(data);
            }
        }
    );
};

window.isSelecting = false;
window.clearSelection = function() {
    isSelecting = false;
    $('.chunk-line').removeClass('ui-selected');
};

// Clear the selected lines if the user clicks anywhere except the comment form
$(document).mousedown(function(e) {
    if ($(e.target).is('.comment-form *')) {
        return true;
    }
    clearSelection();
    return true;
});

$('#chunk-display').selectable({
    filter: '.chunk-line',
    start: function(event, ui) {
        isSelecting = true;
    },
    stop: function(event, ui) {
        var startLine = Number.MAX_VALUE;
        var endLine = Number.MIN_VALUE;
        $('.chunk-line.ui-selected').each(function(i) {
            var n = parseInt($(this).attr('id').split('-')[1]);
            endLine = Math.max(endLine, n);
            startLine = Math.min(startLine, n);
        });
        showCommentForm(startLine, endLine);
    }
});

$('.vote-buttons').buttonset();
$('.upvote-button').button('option', {
    icons: { primary: 'ui-icon-thumb-up', secondary: null },
    text: false
});
$('.downvote-button').button('option', {
    icons: { primary: 'ui-icon-thumb-down', secondary: null },
    text: false
});
$('.reply-button').button({
    icons: { primary: 'ui-icon-reply', secondary: null },
    text: false
});
$('.delete-button').button({
    icons: { primary: 'ui-icon-delete', secondary: null },
    text: false
});

// hook up some more behavior for each comment
$.each(commentBoundaries, function(index, comment) {
    //reply button
    $('.reply-button', comment.elt).click(function() {
		$.get('{% url caesar.comments.views.reply %}', 
	        { parent: comment.id }	,
	        function(data) {
	            $('.reply-form').remove();
	            // find the appropriate place to insert the form
	            $(comment.elt).append(data);
	        }
	    );
	});

	// delete button
    $('.delete-button', comment.elt).click(function() {
        $.get('{% url caesar.comments.views.delete %}', {
            comment_id: comment.id
        }, function(data) {
            $(comment.elt).remove();        
            $('.chunk-line').removeClass('highlighted');            
        });
    });

    $('.upvote-button,.downvote-button', comment.elt).click(function() {
        var button = this;
        var isUp = ($(this).val() == 'up');
        if ($(this).is(':checked')) {
            $.post('{% url caesar.comments.views.vote %}', {
                comment_id: comment.id,
                value: (isUp ? 1 : -1)
            }, function(data) {
                // deselect the other vote button if it is selected
                if (isUp && $(button).nextAll('input').is(':checked')) {
                    // trigger it this way to prevent hitting the handler on the
                    // other checkbox
                    $(button).nextAll('input').attr('checked', false).change();
                } else if (!isUp && $(button).prevAll('input').is(':checked')) {
                    // trigger it this way to prevent hitting the handler on the
                    // other checkbox
                    $(button).prevAll('input').attr('checked', false).change();
                }
                $('.comment-votes', comment.elt).html(data)
                    .effect('highlight', {}, 1000);
            });
        } else {
            $.post('{% url caesar.comments.views.unvote %}', {
                comment_id: comment.id
            }, function(data) {
                $('.comment-votes', comment.elt).html(data)
                    .effect('highlight', {}, 1000);
            });
        }
    });

    // mouseover behavior
    $(comment.elt).mouseover(function() {
        // show little comment action buttons
        $('.comment-actions', this).show();
        // highlight corresponding code lines
        for (var i = comment.start; i <= comment.end; i++) {
            $('#line-' + i).addClass('highlighted');            
        }
    });
    $(comment.elt).mouseout(function() {
        $('.comment-actions', this).hide();
        $('.chunk-line').removeClass('highlighted');            
    });

});


});
</script>

{% endblock %}


{% block content %}

{% comment %}
<div id="chunk-info" class="span-24">
    <h3>
    {{ chunk.file.submission.assignment.name }} :: 
    {{ chunk.file.submission.name }} :: 
    {{ chunk.file.path }}
    </h3>
<}/div>
{% endcomment %}

<div id="chunk-display" class="span-18">
    {% for n, line in lines %}
    <span id="line-{{ n }}" class="chunk-line">
      <span class="line-number">{{ n }}</span><pre class="line-code">{{ line }}</pre>
    </span>
    {% endfor %}
</div>

<script type="text/javascript">	
	$(document).ready(function(){
		//set the initial state
		{% if star.value %}
			$("#star_box").each(function(){ this.checked = true});
		{% endif %}
		$("#star_div").show();
		
		//set the listener
		$("#star_box").click(function(){
			if(this.checked){ //star box was just checked
				$.post('{% url caesar.comments.views.change_star %}', 
					{chunk_id: {{ chunk.id }}, value: "check"} ,
					function(data){}
				);
			} else { // star box was just unchecked
				$.post('{% url caesar.comments.views.change_star %}', 
					{chunk_id: {{ chunk.id }}, value: "uncheck"}, 
					function(data){}
				);
			}
		});
	});
</script>

<div id="comment-display" class="span-6 last">
    {% for comment, vote, snippet in comment_data %}
    
    {% include "comments/comment.html" %} 

    {% endfor %}
</div>

{% if user.is_authenticated %}
<div id="star_div" class="prepend-18 span-6 last">  
  <hr class="space"/>
  <hr/>
  <input type="checkbox" id="star_box" class="star_box_class"/> This code looks good to me. 
</div>
{% endif %}

{% endblock %}

