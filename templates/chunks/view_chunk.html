{% extends "base.html" %}


{% block css %}
{{ block.super }}

<link rel="stylesheet" href="{{ STATIC_URL }}css/chunks.css" type="text/css" />
<link rel="stylesheet" href="{{ STATIC_URL }}css/comments.css" type="text/css" />
<link rel="stylesheet" href="{{ STATIC_URL }}css/syntax.css" type="text/css" />

{% endblock %}

{% block js %}

{{ block.super }}

<script type="text/javascript" charset="utf-8">
var chunkId = {{ chunk.id }};
window.isSelecting = false;

$(document).ready(function() {

var commentBoundaries = $('.comment').map(function() {
    var idSplit = this.id.split('-');
    return { id: parseInt(idSplit[1]), 
             start: parseInt(idSplit[2]), 
             end: parseInt(idSplit[3]),
             isReply: $(this).hasClass('comment-reply'),
             elt: this };
});

function showCommentForm(startLine, endLine) {
    $.get('{% url review.views.new_comment %}', 
        { start: startLine, end: endLine, chunk: chunkId },
        function(data) {
            $('.new-comment').remove();
            // find the appropriate place to insert the form
            var added = false;
            var elt = $(data);
            $.each(commentBoundaries, function(index, comment) {
                if ((startLine == comment.start && endLine >= comment.end)
                    || startLine < comment.start) {
                    $(comment.elt).before(elt);                        
                    added = true;
                    return false;
                }
            });
            if (!added) {
                $('#comment-display-inner').append(elt);
            }
            // construct a fake "comment" boundary object to pass in
            var commentElt = elt.filter('.comment').get(0);
            scrollCodeTo({
                start: startLine, 
                end: endLine, 
                elt: commentElt
            }, true, function() {
                $('textarea').focus();
            }); 
            $(commentElt).effect('highlight', {queue: false}, 2000);
        }
    );
};

function highlightCommentLines(comment) {
    // highlight corresponding code lines
    for (var i = comment.start; i <= comment.end; i++) {
        $('#line-' + i).addClass('highlighted');            
    }
};

function unhighlightCommentLines() {
    $('.line').removeClass('highlighted');            
};

function collapseComment(comment) {
    $(comment.elt).stop(true, true)
            .switchClass('expanded', 'collapsed', 'fast');
    $('.parent-' + comment.id).stop(true, true)
            .switchClass('expanded', 'collapsed', 'fast');
};

function expandComment(comment) {
    $(comment.elt).stop(true, true)
            .switchClass('collapsed', 'expanded', 'fast');
    $('.parent-' + comment.id).stop(true, true)
            .switchClass('collapsed', 'expanded', 'fast');
};

function collapseAllComments() {
    $('.comment').stop(true, true).switchClass('expanded', 'collapsed', 'fast');
};

function expandAllComments() {
    $('.comment').stop(true, true).switchClass('collapsed', 'expanded', 'fast');
};

function scrollCodeTo(comment, doScroll, callback) {
    if (doScroll === undefined) {
        doScroll = true;
    }
    if (callback === undefined) {
        callback = function() { return; };
    }
    var SCROLL_THRESHOLD = 75;
    var targetLine = $('#chunk-line-' + comment.start);
    var commentTop = $(comment.elt).offset().top;
    var commentHeight = $(comment.elt).height();
    var yDelta = targetLine.offset().top - commentTop ;

    // Wraps the callback so it is only executed the nth time it is called
    // This guarantees that the callback is called exactly once and after all
    // animations have run.
    // FIXME Because of the way this code is structured, it is extremely 
    // easy to forget to call the callback in all cases to guarantee execution.
    function wrapCallback(f, n) {
        var i = 0;
        return function() {
            if (i + 1 == n) {
                return f();
            } else {
                i++;
            }
        };
    };

    var cb = wrapCallback(callback, 3);

    $('#comment-display-inner').animate({
        top: '+=' + yDelta
    }, { duration: 500, queue: false, easing: 'easeInOutQuad', complete: cb });

    if (!doScroll) {
        cb(); cb();
        return;
    }

    var windowHeight = $(window).height();
    if (commentTop + yDelta + commentHeight >
            windowHeight + $(window).scrollTop()) {
        $('html,body').animate({
            scrollTop: commentTop - windowHeight + 
                commentHeight + yDelta + SCROLL_THRESHOLD
        }, { duration: 500, queue: false, easing: 'easeInOutQuad',
             complete: cb }); 
    } else if (commentTop + yDelta < $(window).scrollTop()) {
        $('html,body').animate({
            scrollTop: commentTop + yDelta - SCROLL_THRESHOLD
        }, { duration: 500, queue: false, easing: 'easeInOutQuad', 
             complete: cb }); 
    } else {
        cb(); cb();
    }

    return yDelta;
};

function resetScroll() {
    $('#comment-display-inner').animate({
        top: 0
    }, { duration: 500, queue: false });
};

window.clearSelection = function() {
    isSelecting = false;
    $('.line').removeClass('ui-selected');
    $('.new-comment').remove();
};

// Clear the selected lines if the user clicks anywhere except the comment form
$('body').mousedown(function(e) {
    if ($(e.target).is('.new-comment *')) {
        return true;
    }
    clearSelection();
    if (!$(e.target).is('.comment *, .chunk-line *')) {
        resetScroll();
    }
    return true;
});

$('#chunk-display').selectable({
    filter: '.line',
    cancel: '.comment-marker',
    start: function(event, ui) {
        isSelecting = true;
    },
    stop: function(event, ui) {
        var startLine = Number.MAX_VALUE;
        var endLine = Number.MIN_VALUE;
        $('.line.ui-selected').each(function(i) {
            var n = parseInt($(this).attr('id').split('-')[1]);
            endLine = Math.max(endLine, n);
            startLine = Math.min(startLine, n);
        });
        showCommentForm(startLine, endLine);
    }
});

$('.reply-button').button({
    icons: { primary: 'ui-icon-reply', secondary: null },
    text: false
});
$('.delete-button').button({
    icons: { primary: 'ui-icon-delete', secondary: null },
    text: false
});

$('#cancel-button').live('click', function() {
    resetScroll();
    clearSelection();
});

$('#cancel-reply-button').live('click', function() {
    resetScroll();
    $('.reply-form').parent().remove();
});

var toggleCommentsText = {
    collapse: 'Collapse all comments', 
    expand: 'Expand all comments'
};
$('#toggle-comments-button').data('state', 'collapse');
$('#toggle-comments-button').click(function() {
    var state = $(this).data('state');
    if (state === 'collapse') {
        collapseAllComments();
        state = 'expand';
    } else {
        expandAllComments();
        state = 'collapse';
    }
    $(this).text(toggleCommentsText[state]).data('state', state);
});


var toggleInstructionsText = {
    visible: 'Hide instructions', 
    hidden: 'Show instructions' 
};
var instructionsState = $.cookie('instructionsState') || 'visible';

if (instructionsState === 'visible') {
    $('#instructions-text').show();
} else {
    $('#instructions-text').hide();
}
$('#toggle-instructions-button')
        .text(toggleInstructionsText[instructionsState]);

$('#toggle-instructions-button').click(function() {
    if (instructionsState === 'visible') {
        $('#instructions-text').slideUp(400);
        instructionsState = 'hidden';
    } else {
        $('#instructions-text').slideDown(400);
        instructionsState = 'visible';
    }
    $.cookie('instructionsState', instructionsState);
    $(this).text(toggleInstructionsText[instructionsState]);
});

// hook up some more behavior for each comment
$.each(commentBoundaries, function(index, comment) {

    if (!$('#chunk-line-' + comment.start).has('.comment-marker').size()) {
        $('<span></span>')
          .prependTo('#chunk-line-' + comment.start)
          .addClass('comment-marker')
          .data('count', 1)
          .click(function(e) { 
              scrollCodeTo(comment);
              $.each(commentBoundaries, function(index, innerComment) {
                  if (innerComment.start == comment.start) {
                      $(innerComment.elt).effect('highlight', {}, 2000);
                  }
              });
          });
    } else {
        var marker = $('#chunk-line-' + comment.start)
                .children('.comment-marker');
        var count = marker.data('count') + 1;
        marker.data('count', count);
        marker.text(count);
    }

    $('.comment-header', comment.elt).click(function() {
        if ($(comment.elt).hasClass('collapsed')) {
            expandComment(comment);
        } else {
            collapseComment(comment);
        }
        return false;
    });

    $(comment.elt).click(function() {
        if ($(comment.elt).hasClass('collapsed')) {
            expandComment(comment);
        } else {
            scrollCodeTo(comment);
            return false;
        }
    });

    //reply button
    $('.reply-button', comment.elt).click(function() {
		$.get('{% url review.views.reply %}', 
	        { parent: comment.id }	,
	        function(data) {
	            $('.reply-form').parent().remove();
	            // find the appropriate place to insert the form
                var replyElt = $(data).insertAfter(comment.elt);
                scrollCodeTo({
                    start: comment.start, 
                    end: comment.end, 
                    elt: replyElt.get(0) 
                }, true, function() { 
                    $('textarea').focus();
                });
	        }
	    );
        return false;
	});

	// delete button
    $('.delete-button', comment.elt).click(function() {
        $.get('{% url review.views.delete_comment %}', {
            comment_id: comment.id
        }, function(data) {
            $(comment.elt).remove();        
            $('.parent-' + comment.id).remove();
            $('.line').removeClass('highlighted');            
            commentBoundaries.splice(index, 1);
        });
        return false;
    });

    $('.vote-buttons .vote', comment.elt).click(function(e) {
        var button = this;
        var isUp = $(this).hasClass('up');
        if (!$(this).is('.selected')) {
            $.post('{% url review.views.vote %}', {
                comment_id: comment.id,
                value: (isUp ? 1 : -1)
            }, function(data) {
                $(button).addClass('selected');
                // deselect the other vote button if it is selected
                var otherButton = isUp ? $(button).nextAll('.vote') :
                    $(button).prevAll('.vote');
                otherButton.removeClass('selected');
                $('.comment-votes', comment.elt).text(data)
                    .effect('highlight', {queue: false}, 1000);
                $('#done-button').removeAttr('disabled');
            });
        } else {
            $.post('{% url review.views.unvote %}', {
                comment_id: comment.id
            }, function(data) {
                $(button).removeClass('selected');
                $('.comment-votes', comment.elt).text(data)
                    .effect('highlight', {queue: false}, 1000);
            });
        }
        return false;
    });

    // mouseover behavior
    $(comment.elt).mouseover(function() {
        highlightCommentLines(comment);
    });
    $(comment.elt).mouseout(function() {
        unhighlightCommentLines();
    });


});

});
</script>
{% endblock %}

{% block breadcrumbs %}
  <a class="breadcrumb first-breadcrumb" href="{% url review.views.dashboard %}">Dashboard</a>
  <a class="breadcrumb" href="{{ chunk.get_permanent_url }}">{{ chunk.name }}</a>
{% endblock %}

{% block actions %}
{% endblock %}

{% block secondary-toolbar %}
<div id="secondary-toolbar-inner">
  {% if task %}
  <div id="instructions-text">
    <p>Please review this code as if you are writing to the student who wrote 
    it.</p>
    <p>You can:</p>
    <ul>
      <li>Make a comment by clicking or selecting the relevant code lines.</li>
      <li>Upvote or downvote an existing comment.</li>
      <li>Reply to an existing comment to agree, disagree, or discuss.</li>
    </ul>
    <p>Please do at least one thing on this function, then click the "Next" 
    button to go to the next function to review.</p>
  </div>
  {% endif %}
  <div id="chunk-navigation">
    <div id="task-count">
      {% if task %}
      {{ task_count|default:"No" }} function{{ task_count|pluralize }}
      remaining for review
      {% else %}
      You have not been assigned to review this function
      {% endif %}
    </div>
    {% if task %}
      {% if task_count > 0 %}
      <form method="post" 
        action="{% url review.views.change_task %}?task_id={{task.id}}&status=C">
        {% csrf_token %}
        <button id="done-button" type="submit" 
          {% if task.status == 'O' %}disabled{% endif %}>Next</button>
      </form>
      {% else %}
      <a href="https://spreadsheets.google.com/spreadsheet/viewform?formkey=dGNyMlRVTGNTbXFZazA5bDRPd25sZFE6MQ" target="_blank"><button>Feedback survey</button></a>
      {% endif %}
    {% endif %}
  </div>
  <button id="toggle-comments-button" type="button">
    Collapse all comments
  </button>
  {% if task %}
  <button id="toggle-instructions-button" type="button">
    Hide instructions
  </button>
  {% endif %}
</div>
{% endblock %}

{% block content %}

{% comment %}
<div id="chunk-info" class="span-24">
    <h3>
    {{ chunk.file.submission.assignment.name }} :: 
    {{ chunk.file.submission.name }} :: 
    {{ chunk.file.path }}
    </h3>
<}/div>
{% endcomment %}


<div id="comment-display" class="span-6">
    <div id="comment-display-inner">
        {% for comment, vote, snippet in comment_data %}
          {% include "review/comment.html" %} 
        {% endfor %}
    </div>
</div>

<div id="chunk-display" class="span-18 last">
    <div class="syntax">
    {% for n, line in highlighted_lines %}
    <span id="chunk-line-{{ n }}" class="chunk-line">
      <span id="line-{{ n }}" class="line">
        <span class="line-number">{{ n }}</span><pre class="line-code">{{ line|safe }}</pre>
      </span>
    </span>
    {% endfor %}
    </div>
</div>

{% endblock %}

