{% extends "base.html" %}
{% load extra_tags %}

{% block css %}
<!-- bootstap messes this page up, so hacking around it. -->
<link rel="stylesheet" href="{{ STATIC_URL }}css/blueprint/screen.css" type="text/css" media="screen, projection" />
<link rel="stylesheet" href="{{ STATIC_URL }}css/blueprint/print.css" type="text/css" media="print" />
<!--[if lt IE 8]>
<link rel="stylesheet" href="{{ STATIC_URL }}css/blueprint/ie.css" type="text/css" media="screen, projection" />
<![endif]-->
<link rel="stylesheet" href="{{ STATIC_URL}}css/smoothness/jquery-ui.css" type="text/css" media="screen"/>
<link rel="stylesheet" href="{{ STATIC_URL }}css/style.css" type="text/css" />
<link rel="stylesheet" href="{{ STATIC_URL }}css/toolbar.css" type="text/css" />

<link rel="stylesheet" href="{{ STATIC_URL }}css/chunks.css" type="text/css" />
<link rel="stylesheet" href="{{ STATIC_URL }}css/triangle.css" type="text/css" />
<link rel="stylesheet" href="{{ STATIC_URL }}css/comments.css" type="text/css" />
<link rel="stylesheet" href="{{ STATIC_URL }}css/syntax.css" type="text/css" />
<link rel="stylesheet" href="{{ STATIC_URL }}css/fullchunks.css" type="text/css" />

{% endblock %}

{% block js %}
{{ block.super }}

<script type="text/javascript" charset="utf-8">
    caesar.state = {
        taskStatus: '{{ task.status }}',
        chunkId: {{ chunk.id }},
        fullView: {% if full_view %}true{% else %}false{% endif %}
    };
</script>

<script type="text/javascript" src="{{ STATIC_URL }}js/chunk.js?v=1"></script>
<script type="text/javascript" src="{{ STATIC_URL }}js/fullproof-all-debug.js"></script>
<script type="text/javascript" src="{{ STATIC_URL }}js/stopwords.js"></script>
<script type="text/javascript" src="{{ STATIC_URL }}js/comments_search.js"></script>

<script type="text/javascript">
  // on unload this page, clear database
  $(window).on("unload", function() {
    clearDatabase("{{chunk.id}}");
  });

  $(document).ready(function() {

    // on load, clear database
    clearDatabase("{{chunk.id}}");

    // Load previous comments
    $.ajax({
      type: "GET",
      url: "{% url 'chunks.views.load_previous_comments' chunk.id %}",
      success: function(data){
        commentsData = data.commentsData;
        commentsExtraData = data.commentsExtraData;
        highlightedLines = data.highlightedLines;
        commentSearch.init(commentsData, commentsExtraData, "{{chunk.id}}");

        for (var line in highlightedLines) {
          var comment_id = highlightedLines[line].comment_id;
          var chunk_lines = highlightedLines[line].chunk_lines;
          var comment_chunk_id = highlightedLines[line].comment_chunk_id;
          var comment_chunk_file_id = highlightedLines[line].comment_chunk_file_id;
          var bubble = $("span").addClass("bubble triangle-border left").attr("id", "bubble-"+comment_id);
          var syntax = $("div").addClass("syntax");
          var outer;
          for (var chunk_line in chunk_lines) {
            var n = chunk_lines[chunk_line][0];
            var line = chunk_lines[chunk_line][1];
            var staff_code = chunk_lines[chunk_line][2];
            outer = $("a").addClass("chunk-line").attr({
              "id": "chunk-"+comment_chunk_id+"-line-"+n,
              "href": "/chunks/view/"+comment_chunk_id+"#comment-"+comment_id,
              "target": "_blank",
            });
            if (staff_code) {
              outer.addClass("chunk-line-staff");
            }
            else {
              outer.addClass("chunk-line-student");
            }
            var middle = $("span").addClass("bubble-line").attr("id", "line-"+comment_chunk_id+"-"+n+"-"+comment_chunk_file_id);
            var inner_span = $("span").addClass("line-number").text(n);
            var inner_pre = $("pre").addClass("line-code").text(line);
            middle.append(inner_span, inner_pre);
            outer.append(middle);
          }
          /*syntax.append(outer);
          bubble.append(syntax);
          $("body").append(bubble);*/
        }
        console.log("success!");
      }
    });

    // Add comments to database
    /*var commentsData = [];
    var commentsExtraData = [];
    {%comment%}{% for comment, chunk_line in old_comment_data %}

      // Need to use escapejs filter to escape newline characters coming from the textarea
      commentsData.push("{{comment.text|escapejs}}");

      // Need to save extra information about each comment. Only save the author and the link to the author's profile page if the author is not the current user.
      var author = "";
      var author_url = "";
      {% if role != 'S' and comment.author.username != user.username %}
        author = "{{comment.author.get_full_name|default:comment.author.username}} ({{comment.author.profile.reputation}})";
        author_url = "{% url 'accounts.views.view_profile' comment.author.username %}"
      {% endif %}
      commentsExtraData.push({
        "comment_id": "{{comment.id}}",
        "date": "{{comment.created|timesince_human}}",
        "chunk_name": "{{comment.chunk.name}}",
        "chunk_url": "{% url 'chunks.views.view_comment' comment.id %}",
        "author": author,
        "author_url": author_url,

      });
    {% endfor %}

    commentSearch.init(commentsData, commentsExtraData, "{{chunk.id}}");{%endcomment%}*/

  });

</script>

{% endblock %}

{% block breadcrumbs %}
  <a class="breadcrumb first-breadcrumb" href="{% url 'dashboard.views.dashboard' %}">Dashboard</a>
  <span class="breadcrumb" href="{{ chunk.get_absolute_url }}">{{ chunk.name }}</span>
  {% if similar_chunks %}
  <div class="dropdown">
    <a id="similar-link" class="breadcrumb dropdown-link">Similar code..</a>
    <ul class="dropdown-menu">
      {% for c in similar_chunks %}
      <li><a href="{{ c.get_absolute_url }}">{{ c.name }}</a></li>
      {% endfor %}
    </ul>
  </div>
  {% endif %}
{% endblock %}

{% block actions %}
{% endblock %}

{% block secondary-toolbar %}
<div id="secondary-toolbar-inner">
  {% if task %}
  <div id="instructions-text">
    <p>Please review this code as if you are writing to the student who wrote 
    it.  You can:</p>
    <ul>
      <li>Make a comment by clicking or selecting the relevant code lines. <span class="colorred"> The white lines show student-authored code; gray lines were provided by staff.</span></li>
      <li>Upvote or downvote an existing comment.</li>
      <li>Reply to an existing comment to agree, disagree, or discuss.</li>
    </ul>
    <p>Please do at least one thing on this code, then click the
      {% if not last_task %} Next button to go to the next methods to review.
      {% else %} Done button.
      {% endif %}
    </p>
  </div>
  {% endif %}
  <div id="chunk-navigation">
    <div id="task-count">
      {% if task %}
        {{ remaining_task_count|default:"No" }} 
        {% if not task.status == 'C' or task.status == 'U' %} additional {% endif %}
        code section{{ remaining_task_count|pluralize }}
        remaining for review
      {% else %}
        You have not been assigned to review this code.
      {% endif %}
    </div>
    {% if task %}
      <!-- mark task you're viewing as complete -->
      {% if remaining_task_count > 0 or last_task %}
        <form method="get" action="{% url 'tasks.views.change_task' %}">
          <input type="hidden" name="task_id" value="{{ task.id }}"/>
          <input type="hidden" name="status" value='C'/>
          <button id="done-button" type="submit">
          {% if remaining_task_count > 0 %}
            Next
          {% elif last_task %}
            Done!
          {% endif %}
          </button>
        </form>
      {% else %}
          <a href='https://spreadsheets.google.com/spreadsheet/viewform?formkey=dGNyMlRVTGNTbXFZazA5bDRPd25sZFE6MQ' target="_blank"><button>Fill out the Feedback survey</button></a>
      {% endif %}
    {% endif %}
  </div>
  <button id="toggle-comments-button" type="button">
    Collapse all comments
  </button>
  <button id="toggle-auto-comments-button" type="button">
    Collapse all checkstyle comments
  </button>
  {% if task %}
  <button id="toggle-instructions-button" type="button">
    Hide instructions
  </button>
  {% endif %}
</div>
{% endblock %}

{% block content %}

{% comment %}
<div id="chunk-info" class="span-24">
    <h3>
    {{ chunk.file.submission.assignment.name }} :: 
    {{ chunk.file.submission.name }} :: 
    {{ chunk.file.path }}
    </h3>
</div>
{% endcomment %}
<div id ="view-all-code">
    <a href="{% url 'chunks.views.view_all_chunks' 'code' chunk.file.submission.id %}">
      view all code
    </a>
</div>
<br/>
<div id="comment-display" class="span-6">
  <div style="mid-width:30em" id="comment-display-inner" class="file-{{file.id}} files">
     {% for comment, vote, snippet in comment_data %}
       {% include "review/comment.html" %} 
     {% endfor %}
  </div>
</div>

<div id="chunk-display" class="span-18 last">
  <div class="syntax">
  {% for n, line, staff_code in highlighted_lines %}
  {% if not staff_code %}
  <span id="chunk-{{chunk.id}}-line-{{ n }}" class="chunk-line chunk-line-student">
    <span id="line-{{chunk.id}}-{{ n }}-{{file.id}}" class="line">
      <span class="line-number">{{ n }}</span><pre class="line-code">{{ line|safe }}</pre>
    </span>
  </span>
  {% else %}
  <span id="chunk-{{chunk.id}}-line-{{ n }}" class="chunk-line chunk-line-staff">
    <span id="line-{{chunk.id}}-{{ n }}-{{file.id}}" class="line">
      <span class="line-number">{{ n }}</span><pre class="line-code">{{ line|safe }}</pre>
    </span>
  </span>
  {% endif %}
  {% endfor %}
  </div>
</div>

<!--
{%comment%}{% for comment, chunk_line in old_comment_data %}
  <span class='bubble triangle-border left' id='bubble-{{ comment.id }}'>
    <div class="syntax">
    {% for n, line, staff_code in chunk_line %}
      {% if not staff_code %}
        <a id="chunk-{{comment.chunk.id}}-line-{{ n }}" class="chunk-line chunk-line-student" href='/chunks/view/{{comment.chunk.id}}#comment-{{comment.id}}' target='_blank'>
          <span id="line-{{comment.chunk.id}}-{{ n }}-{{comment.chunk.file.id}}" class="bubble-line">
            <span class="line-number">{{ n }}</span><pre class="line-code">{{ line|safe }}</pre>
          </span>
        </a>
      {% else %}
        <a id="chunk-{{comment.chunk.id}}-line-{{ n }}" class="chunk-line chunk-line-staff" href = '/chunks/view/{{comment.chunk.id}}#comment-{{comment.id}}' target='_blank'>
          <span id="line-{{comment.chunk.id}}-{{ n }}-{{comment.chunk.file.id}}" class="bubble-line">
            <span class="line-number">{{ n }}</span><pre class="line-code">{{ line|safe }}</pre>
          </span>
        </a>
      {% endif %}
    {% endfor %}
    </div>
  </span>
{% endfor%}{%endcomment%}
-->
{% endblock %}

