{% extends "base.html" %}

{% block extrahead %}

<style type="text/css">
    .ui-selected {
        background-color: #FFFF5A;
    }
    .ui-selecting {
        background-color: #FFFFCA;
    }

    .ui-button-text {
        font-size: 75%;
    }

    textarea {
        width: 100%;
    }
</style>

<script type="text/javascript">

$(document).ready(function() {

var commentBoundaries = $('.comment').map(function() {
    var idSplit = this.id.split('-');
    return { id: parseInt(idSplit[1]), 
             start: parseInt(idSplit[2]), 
             end: parseInt(idSplit[3]),
             elt: this };
});

$('#chunk-display').selectable({
    stop: function(event, ui) {
        var startLine = Number.MAX_VALUE;
        var endLine = Number.MIN_VALUE;
        $('.chunk-line.ui-selected').each(function(i) {
            var n = parseInt($(this).attr('id').split('-')[1]);
            endLine = Math.max(endLine, n);
            startLine = Math.min(startLine, n);
        });

        $.get('{% url caesar.comments.views.new %}', 
            { start: startLine, end: endLine, chunk: {{ chunk.id }} },
            function(data) {
                $('.comment-form').remove();
                // find the appropriate place to insert the form
                var added = false;
                $.each(commentBoundaries, function(index, comment) {
                    if ((startLine == comment.start && endLine <= comment.end)
                        || startLine < comment.start) {
                        $(comment.elt).before(data);                        
                        added = true;
                        return false;
                    }
                });
                if (!added) {
                    $('#comment-display').append(data);
                }
            }
        );
    }
});

$('.vote-buttons').buttonset();

// hook up some more behavior for each comment
$.each(commentBoundaries, function(index, comment) {
    // delete button
    $('.delete-button', comment.elt).click(function() {
        $.get('{% url caesar.comments.views.delete %}', {
            comment_id: comment.id
        }, function(data) {
            $(comment.elt).remove();        
        });
    });

    $('.upvote-button,.downvote-button', comment.elt).click(function() {
        var button = this;
        var isUp = ($(this).val() == 'up');
        if ($(this).is(':checked')) {
            $.post('{% url caesar.comments.views.vote %}', {
                comment_id: comment.id,
                value: (isUp ? 1 : -1)
            }, function(data) {
                // deselect the other vote button if it is selected
                if (isUp && $(button).nextAll('input').is(':checked')) {
                    // trigger it this way to prevent hitting the handler on the
                    // other checkbox
                    $(button).nextAll('input').attr('checked', false).change();
                    console.log("A");
                } else if (!isUp && $(button).prevAll('input').is(':checked')) {
                    // trigger it this way to prevent hitting the handler on the
                    // other checkbox
                    $(button).prevAll('input').attr('checked', false).change();
                    console.log("B");
                }
                $('.comment-votes', comment.elt).html(data)
                    .effect('highlight', {}, 1000);
            });
        } else {
            $.post('{% url caesar.comments.views.unvote %}', {
                comment_id: comment.id
            }, function(data) {
                $('.comment-votes', comment.elt).html(data)
                    .effect('highlight', {}, 1000);
            });
        }
    });

    // mouseover behavior
    $(comment.elt).mouseover(function() {
        // show little comment action buttons
        $('.comment-actions', this).show();
        // highlight corresponding code lines
        $('#chunk-display *').removeClass('ui-selected');
        for (var i = comment.start; i <= comment.end; i++) {
            $('#line-' + i).addClass('ui-selected');            
        }
    });
    $(comment.elt).mouseout(function() {
        $('.comment-actions', this).hide();
        for (var i = comment.start; i <= comment.end; i++) {
            $('#line-' + i).removeClass('ui-selected');            
        }
    });

});


});
</script>

{% endblock %}


{% block content %}

<div id="chunk-info" class="span-24">
    <h3>
    {{ chunk.file.submission.assignment.name }} :: 
    {{ chunk.file.submission.name }} :: 
    {{ chunk.file.path }}
    </h3>
</div>

<hr/>


<div id="chunk-display" class="span-17 colborder">
    {% for n, line in lines %}
    <span id="line-{{ n }}" class="chunk-line">
      <span class="line-number">{{ n }}</span><pre class="line-code">{{ line }}</pre>
    </span>
    {% endfor %}
</div>

<div id="comment-display" class="span-6 last">

    {% for comment, vote in comment_data %}
    
    {% include "comments/comment.html" %} 

    {% endfor %}

</div>



{% endblock %}

