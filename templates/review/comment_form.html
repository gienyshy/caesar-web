<!--<link rel="stylesheet" href="{{ STATIC_URL }}css/bootstrap.min.css" type="text/css">-->
{% load extra_tags %}
<script type="text/javascript">

/////////////////////////////////////////////////////////////////////////////////
// Boolean Engine
/////////////////////////////////////////////////////////////////////////////////

/*  var commentsData = [];
  var commentsDates = [];
  {% for comment in oldComments %}
    {% if not comment.deleted %}
      commentsData.push("{{comment.text}}");
      commentsDates.push("{{comment.created|timesince_human}}");
    {% endif %}
  {% endfor %}

  var dbName = "reusedComments";
  var commentsSearchEngine = new fullproof.BooleanEngine();

  var index1 = {
      name: "normalindex",
      analyzer: new fullproof.StandardAnalyzer(fullproof.normalizer.to_lowercase_nomark, fullproof.normalizer.remove_duplicate_letters),
      capabilities: new fullproof.Capabilities().setUseScores(false).setDbName(dbName),
      initializer: initializer
  };
  var index2 = {
      name: "stemmedindex",
      analyzer: new fullproof.StandardAnalyzer(fullproof.normalizer.to_lowercase_nomark, fullproof.english.metaphone),
      capabilities: new fullproof.Capabilities().setUseScores(false).setDbName(dbName),
      initializer: initializer
  };
  
  function initializer(injector, callback) {
      var synchro = fullproof.make_synchro_point(callback, commentsData.length);
      var values = [];
      for (var i=0;i<commentsData.length; ++i) {
        values.push(i);
      }
      injector.injectBulk(commentsData, values, callback);
  }
  function engineReady(b) {
      if (!b) {
          alert("Can't load the search engine!");
      }
  }
  commentsSearchEngine.open([index1, index2], fullproof.make_callback(engineReady, true), fullproof.make_callback(engineReady, false));
  
  function search() {
      $(".reuse-comment").remove();
      var value = $("#textentry").val();
      // Request a search to the comments engine, then displays the results, if any.
      commentsSearchEngine.lookup(value, function(resultset) {
        var results = [];
        var dates = [];
        if (resultset && resultset.getSize()) {
          var rsize = resultset.getSize();
          resultset.forEach(function(e) {
            results.push(commentsData[e]);
            dates.push(commentsDates[e]);
          });
        }
        for (var i=0; i<Math.min(results.length, 3); i++) {
          var comment_div = $("<div class='comment reuse-comment expanded'></div>");
          comment_div.append("<div class='comment-header'>"+dates[i]+" ago you wrote a similar comment:</div>");
          //comment_div.append("<div class='comment-author'>"+dates[i]+" ago</div>");
          comment_div.append("<div class='reuse-comment-text'><textarea readOnly='true' onclick='select()' onselect='' cols='10' rows='5'>"+results[i]+"</textarea></div>");
          $(".new-comment").after(comment_div);
        }
        //$(".reuse-comment").hide();
        //$(".reuse-comment").show("blind");
      });
  }

  $(".new-comment").on("remove", function() {
    $(".reuse-comment").remove();
  });*/

/////////////////////////////////////////////////////////////////////////////////
// Scoring Engine
/////////////////////////////////////////////////////////////////////////////////

$(document).ready(function() {

  // Clear reusedComments database !important
  var db = openDatabase('reusedComments', '1.0', 'reusedComments', 2 * 1024 * 1024);
  db.transaction(function (tx) {
    tx.executeSql('DROP TABLE fullproofmetadata');
    tx.executeSql('DROP TABLE normalindex');
    tx.executeSql('DROP TABLE stemmedindex');
  });

  // Add comments to database
  var commentsData = [];
  var commentsExtraData = [];
  {% for comment in oldComments %}
    commentsData.push("{{comment.text}}");
    commentsExtraData.push({
      "date": "{{comment.created|timesince_human}}",
      "chunk_name": "{{comment.chunk.name}}",
      "chunk_url": "{% url 'chunks.views.view_comment' comment.id %}"
    });
  {% endfor %}

  var dbName = "reusedComments";
  var commentsSearchEngine = new fullproof.ScoringEngine();

  function initializer(injector, callback) {
      var synchro = fullproof.make_synchro_point(callback, commentsData.length-1);
      var values = [];
      for (var i=0;i<commentsData.length; ++i) {
        values.push(i);
      }
      injector.injectBulk(commentsData, values, callback);
  }

  var index1 = new fullproof.IndexUnit(
      "normalindex",
      new fullproof.Capabilities().setStoreObjects(false).setUseScores(true).setDbName(dbName).setComparatorObject(fullproof.ScoredEntry.comparatorObject).setDbSize(8*1024*1024),
      new fullproof.ScoringAnalyzer(fullproof.normalizer.to_lowercase_nomark, fullproof.normalizer.remove_duplicate_letters),
      initializer
  );
  var index2 = new fullproof.IndexUnit(
      "stemmedindex",
      new fullproof.Capabilities().setStoreObjects(false).setUseScores(true).setDbName(dbName).setComparatorObject(fullproof.ScoredEntry.comparatorObject).setDbSize(8*1024*1024),
      new fullproof.ScoringAnalyzer(fullproof.normalizer.to_lowercase_nomark, fullproof.english.metaphone),
      initializer
  );
  
  function engineReady(b) {
      if (!b) {
          alert("Can't load the search engine!");
      }
  }

  commentsSearchEngine.open([index1,index2], fullproof.make_callback(engineReady, true), fullproof.make_callback(engineReady, false));
  
  function search() {
      $(".reuse-comment").remove();
      var value = $("#textentry").val();

      // Request a search to the comments engine, then displays the results, if any.
      commentsSearchEngine.lookup(value, function(resultset) {
        var results = [];
        if (resultset && resultset.getSize()) {
          var rsize = resultset.getSize();

          // resultset is a fullproof object that has its own forEach method
          resultset.forEach(function(e) {
            // Only choose scores that are "good enough"
            if (e.score >= 2.5) {
              results.push({
                "index": e.value,
                "score": e.score
              });
            }
          });
        }

        // Sort results from highest score to lowest score
        results.sort(function(a,b) { return b.score - a.score; });

        // Display only the top 3 results. Insert them below the new-comment div. Insert them backwards so that they are displayed in the correct order (because .after() appends directly after the new-comment div so we want to append the highest score last).
        // Use .html() rather than .text() to deal with special characters.
        for (var i=Math.min(results.length-1, 2); i>=0; i--) {
          var comment_div = $("<div class='comment reuse-comment expanded'></div>");

          var comment_header = $("<div class='comment-header'></div>").html(commentsExtraData[results[i].index].date+" ago you wrote a similar comment.");

          var comment_chunkdiv = $("<div class='comment-author'></div>");
          var comment_chunk_link = $("<a href='"+commentsExtraData[results[i].index].chunk_url+"' target='_blank'></div>").html(commentsExtraData[results[i].index].chunk_name);
          comment_chunkdiv.append(comment_chunk_link);

          var comment_textdiv = $("<div class='reuse-comment-text'></div>");
          var comment_textarea = $("<textarea cols='10' rows='5'></textarea>").html(commentsData[results[i].index]).attr("readonly", "readonly");
          comment_textdiv.append(comment_textarea);

          comment_div.append(comment_header, comment_chunkdiv, comment_textdiv);
          $(".new-comment").after(comment_div);
        }
      });
  }

  // Remove all reuse-comment divs whenever the user closes a new comment entry box.
  $(".new-comment").on("remove", function() {
    $(".reuse-comment").remove();
  });

  $("#textentry").keypress(function(event) {
    ///////////////////////////////////////////////
    // TODO: This needs to be changed!
    // Test whether user has finished typing a word
    ///////////////////////////////////////////////
    if (event.which == 32) {
      search();
    }


  });
});

</script>

<div class="comment new-comment" title="Add a comment">
  <div class="comment-header">
    <span class="comment-line-numbers">
    {{ start }}
    {% if end != start %} - {{ end }}
    {% endif %}
    </span>
    <span class="comment-snippet">
    {{ snippet }}
    </span>
  </div>
  <div class="comment-form">
    <form id="new-comment-form" 
      action="{% url 'review.views.new_comment' %}" method="post">
      {% csrf_token %}
      {{ form.text }}
      {{ form.start }}
      {{ form.end }}
      {{ form.chunk }}
      <button type="submit">Save</button>
      <button id="cancel-button" type="button">Cancel</button>
    </form>
  </div>
</div>
