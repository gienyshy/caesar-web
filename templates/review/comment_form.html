<!--<link rel="stylesheet" href="{{ STATIC_URL }}css/bootstrap.min.css" type="text/css">-->
<!--<link rel="stylesheet" href="{{ STATIC_URL }}css/jquery.textcomplete.css" type="text/css">-->
<!--<script type="text/javascript" src = "{{ STATIC_URL }}/js/jquery.textcomplete.min.js"></script>-->
{% load extra_tags %}
<script type="text/javascript" src="{{ STATIC_URL }}/js/fullproof-all.js"></script>
<script type="text/javascript">

  var common_english_words = ["the", "name", "of", "very", "to", "through", "and", "just", "a", "form", "in", "much", "is", "great", "it", "think", "you", "say", "that", "help", "he", "low", "was", "line", "for", "before", "on", "turn", "are", "cause", "with", "same", "as", "mean", "I", "differ", "his", "move", "they", "right", "be", "boy", "at", "old", "one", "too", "have", "does", "this", "tell", "from", "sentence", "or", "set", "had", "three", "by", "want", "hot", "air", "but", "well", "some", "also", "what", "play", "there", "small", "we", "end", "can", "put", "out", "home", "other", "read", "were", "hand", "all", "port", "your", "large", "when", "spell", "up", "add", "use", "even", "word", "land", "how", "here", "said", "must", "an", "big", "each", "high", "she", "such", "which", "follow", "do", "act", "their", "why", "time", "ask", "if", "men", "will", "change", "way", "went", "about", "light", "many", "kind", "then", "off", "them", "need", "would", "house", "write", "picture", "like", "try", "so", "us", "these", "again", "her", "animal", "long", "point", "make", "mother", "thing", "world", "see", "near", "him", "build", "two", "self", "has", "earth", "look", "father", "more", "head", "day", "stand", "could", "own", "go", "page", "come", "should", "did", "country", "my", "found", "sound", "answer", "no", "school", "most", "grow", "number", "study", "who", "still", "over", "learn", "know", "plant", "water", "cover", "than", "food", "call", "sun", "first", "four", "people", "thought", "may", "let", "down", "keep", "side", "eye", "been", "never", "now", "last", "find", "door", "any", "between", "new", "city", "work", "tree", "part", "cross", "take", "since", "get", "hard", "place", "start", "made", "might", "live", "story", "where", "saw", "after", "far", "back", "sea", "little", "draw", "only", "left", "round", "late", "man", "run", "year", "don't", "came", "while", "show", "press", "every", "close", "good", "night", "me", "real", "give", "life", "our", "few", "under", "stop", "open", "ten", "seem", "simple", "together", "several", "next", "vowel", "white", "toward", "children", "war", "begin", "lay", "got", "against", "walk", "pattern", "example", "slow", "ease", "center", "paper", "love", "often", "person", "always", "money", "music", "serve", "those", "appear", "both", "road", "mark", "map", "book", "science", "letter", "rule", "until", "govern", "mile", "pull", "river", "cold", "car", "notice", "feet", "voice", "care", "fall", "second", "power", "group", "town", "carry", "fine", "took", "certain", "rain", "fly", "eat", "unit", "room", "lead", "friend", "cry", "began", "dark", "idea", "machine", "fish", "note", "mountain", "wait", "north", "plan", "once", "figure", "base", "star", "hear", "box", "horse", "noun", "cut", "field", "sure", "rest", "watch", "correct", "color", "able", "face", "pound", "wood", "done", "main", "beauty", "enough", "drive", "plain", "stood", "girl", "contain", "usual", "front", "young", "teach", "ready", "week", "above", "final", "ever", "gave", "red", "green", "list", "oh", "though", "quick", "feel", "develop", "talk", "sleep", "bird", "warm", "soon", "free", "body", "minute", "dog", "strong", "family", "special", "direct", "mind", "pose", "behind", "leave", "clear", "song", "tail", "measure", "produce", "state", "fact", "product", "street", "black", "inch", "short", "lot", "numeral", "nothing", "class", "course", "wind", "stay", "question", "wheel", "happen", "full", "complete", "force", "ship", "blue", "area", "object", "half", "decide", "rock", "surface", "order", "deep", "fire", "moon", "south", "island", "problem", "foot", "piece", "yet", "told", "busy", "knew", "test", "pass", "record", "farm", "boat", "top", "common", "whole", "gold", "king", "possible", "size", "plane", "heard", "age", "best", "dry", "hour", "wonder", "better", "laugh", "true", "thousand", "during", "ago", "hundred", "ran", "am", "check", "remember", "game", "step", "shape", "early", "yes", "hold", "hot", "west", "miss", "ground", "brought", "interest", "heat", "reach", "snow", "fast", "bed", "five", "bring", "sing", "sit", "listen", "perhaps", "six", "fill", "table", "east", "travel", "weight", "less", "language", "morning", "among"];


/////////////////////////////////////////////////////////////////////////////////
// Boolean Engine
/////////////////////////////////////////////////////////////////////////////////

/*  var commentsData = [];
  var commentsDates = [];
  {% for comment in oldComments %}
    {% if not comment.deleted %}
      commentsData.push("{{comment.text}}");
      commentsDates.push("{{comment.created|timesince_human}}");
    {% endif %}
  {% endfor %}

  var dbName = "reusedComments";
  var commentsSearchEngine = new fullproof.BooleanEngine();

  var index1 = {
      name: "normalindex",
      analyzer: new fullproof.StandardAnalyzer(fullproof.normalizer.to_lowercase_nomark, fullproof.normalizer.remove_duplicate_letters),
      capabilities: new fullproof.Capabilities().setUseScores(false).setDbName(dbName),
      initializer: initializer
  };
  var index2 = {
      name: "stemmedindex",
      analyzer: new fullproof.StandardAnalyzer(fullproof.normalizer.to_lowercase_nomark, fullproof.english.metaphone),
      capabilities: new fullproof.Capabilities().setUseScores(false).setDbName(dbName),
      initializer: initializer
  };
  
  function initializer(injector, callback) {
      var synchro = fullproof.make_synchro_point(callback, commentsData.length);
      var values = [];
      for (var i=0;i<commentsData.length; ++i) {
        values.push(i);
      }
      injector.injectBulk(commentsData, values, callback);
  }
  function engineReady(b) {
      if (!b) {
          alert("Can't load the search engine!");
      }
  }
  commentsSearchEngine.open([index1, index2], fullproof.make_callback(engineReady, true), fullproof.make_callback(engineReady, false));
  
  function search() {
      $(".reuse-comment").remove();
      var value = $("#textentry").val();
      // Request a search to the comments engine, then displays the results, if any.
      commentsSearchEngine.lookup(value, function(resultset) {
        var results = [];
        var dates = [];
        if (resultset && resultset.getSize()) {
          var rsize = resultset.getSize();
          resultset.forEach(function(e) {
            results.push(commentsData[e]);
            dates.push(commentsDates[e]);
          });
        }
        for (var i=0; i<Math.min(results.length, 3); i++) {
          var comment_div = $("<div class='comment reuse-comment expanded'></div>");
          comment_div.append("<div class='comment-header'>"+dates[i]+" ago you wrote a similar comment:</div>");
          //comment_div.append("<div class='comment-author'>"+dates[i]+" ago</div>");
          comment_div.append("<div class='reuse-comment-text'><textarea readOnly='true' onclick='select()' onselect='' cols='10' rows='5'>"+results[i]+"</textarea></div>");
          $(".new-comment").after(comment_div);
        }
        //$(".reuse-comment").hide();
        //$(".reuse-comment").show("blind");
      });
  }

  $(".new-comment").on("remove", function() {
    $(".reuse-comment").remove();
  });*/

/////////////////////////////////////////////////////////////////////////////////
// Scoring Engine
/////////////////////////////////////////////////////////////////////////////////

  var commentsData = [];
  {% for comment in oldComments %}
    commentsData.push("{{comment.text}}");
  {% endfor %}

  function loadData(callbackWhenDone) {
    var loader = new fullproof.DataLoader();
    loader.setQueue("colors.csv");
    loader.start(fullproof.make_callback(callbackWhenDone, true),
            function(txt) {
                colorsData = txt.split("\n");
            }, fullproof.make_callback(callbackWhenDone, false));
  }

  var dbName = "reusedComments";
  var commentsSearchEngine = new fullproof.ScoringEngine();

  function initializer(injector, callback) {
      console.log("hi");
      var synchro = fullproof.make_synchro_point(callback, commentsData.length-1);
      var values = [];
      for (var i=0;i<commentsData.length; ++i) {
        values.push(fullproof.ScoredEntry(commentsData[i], i, 1.0));
        //values.push(i);
        //injector.inject(commentsData[i], fullproof.ScoredElement(i, 1.0), synchro);
        //injector.inject(commentsData[i], i, synchro);
      }

      injector.injectBulk(commentsData, values, synchro);
  }

  var index1 = new fullproof.IndexUnit(
      "normalindex",
      new fullproof.Capabilities().setUseScores(true).setDbName(dbName).setComparatorObject(fullproof.ScoredEntry.comparatorObject),
      new fullproof.ScoringAnalyzer(fullproof.normalizer.to_lowercase_nomark, fullproof.normalizer.remove_duplicate_letters),
      initializer
  );
  var index2 = new fullproof.IndexUnit(
      "stemmedindex",
      new fullproof.Capabilities().setUseScores(true).setDbName(dbName).setComparatorObject(fullproof.ScoredEntry.comparatorObject),
      new fullproof.ScoringAnalyzer(fullproof.normalizer.to_lowercase_nomark, fullproof.english.metaphone),
      initializer
  );
  
  function engineReady(b) {
      if (!b) {
          alert("Can't load the search engine!");
      }
  }

  commentsSearchEngine.open([index1, index2], fullproof.make_callback(engineReady, true), fullproof.make_callback(engineReady, false));
  
  function search() {
      var value = $("#textentry").val();
              console.log(commentsSearchEngine);
      // Request a search to the comments engine, then displays the results, if any.
      commentsSearchEngine.lookup(value, function(resultset) {
        console.log("comparing");
        resultset.setComparatorObject({
          lower_than: function(a,b) {
            console.log("a: " + a);
            console.log("b: " + b);
            return a.score > b.score;
          },
          equals: function(a,b) {
            console.log("here");
            return a.score === b.score;
          }
        });
        var result = [];
        if (resultset && resultset.getSize()) {
            var rsize = resultset.getSize();
            console.log(resultset);
            resultset.forEach(function(e) {
                //var c = commentsData[e];
                //result.push(c);
                console.log(e);
            });
        } else {
        }
      });
  }

  $("#textentry").keypress(function(event) {
    ///////////////////////////////////////////////
    // TODO: This needs to be changed!
    // Test whether user has finished typing a word
    ///////////////////////////////////////////////
    if (event.which == 32) {
      search();
    }


  });


/////////////////////////////////////////////////////////////////////////////////
// Textentry autocomplete
/////////////////////////////////////////////////////////////////////////////////

  // Generate a short snippet which contains the given substrings
  /*function generate_relevant_snippet(comment, substrings) {
    var snippet_length = 30;
    // To do comparisons, make comments and substrings lowercase.
    var lowercase_comment = comment.toLowerCase();
    var lowercase_substrings = [];
    for (var i in substrings) {
      lowercase_substrings.push(substrings[i].toLowerCase());
    }

    // Check to make sure all of the substrings are in the comment
    for (var i in lowercase_substrings) {
      var index = lowercase_comment.indexOf(lowercase_substrings[i]);
      if (index == -1) {
        return null;
      }
    }

    // If the comment length is shorter than the snippet length, no need to make a snippet!
    if (lowercase_comment.length < snippet_length) {
      return comment;
    }

    // Include buffer characters before and after the last keyword (most recently typed)
    var last = lowercase_substrings.length - 1;
    index = lowercase_comment.indexOf(lowercase_substrings[last]);
    var bufferchars = (snippet_length - lowercase_substrings[last].length) / 2;
    if (index < bufferchars) { // Substring found very close to beginning of text
      return comment.slice(0,snippet_length) + "...";
    }
    if (index + lowercase_substrings[last].length + bufferchars > lowercase_comment.length) { // Substring found very close to end of text
      return "..." + comment.slice(-snippet_length);
    }
    return "..." + comment.slice(index-bufferchars, index+snippet_length-bufferchars) + "...";
  }

  var oldCommentsArray = [];
  {% for comment in oldComments %}
    oldCommentsArray.push("{{comment.text}}");
  {% endfor %}

  // Textcomplete
  $("#textentry").textcomplete([{
    match: /((\w+)(\W+))+$/,
    search: function (term, callback) {
        var words_in_textentry = term.split(' ');

        // Remove all blacklisted words (common English words)
        var keywords = [];
        for (var i in words_in_textentry) {
          var lowercase_word = words_in_textentry[i].toLowerCase();
          if (common_english_words.indexOf(lowercase_word) == -1 && lowercase_word != "") {
            keywords.push(words_in_textentry[i]);
          }
        }
        if (keywords.length == 0) {
          return null;
        }
        callback($.map(oldCommentsArray, function (comment) {
          // Generate comment snippets
          var relevant_snippet = generate_relevant_snippet(comment, keywords);
          if (relevant_snippet != null) {
            var value = {0: relevant_snippet, 1: comment};
            return value;
          }
          return null;

        }));
    },
    template: function(value) {
        return value[0];
    },
    replace: function (value) {
        return value[1];
    },
    index: 1,
    maxCount: 5
  }]);*/

  /*$("#textentry").keypress(function(event) {
    ///////////////////////////////////////////////
    // TODO: This needs to be changed!
    // Test whether user has finished typing a word
    ///////////////////////////////////////////////
    if (
          //event.which == 8 || // Backspace
          event.which == 32 || // Space
          event.which == 33 || // !
          event.which == 63 || // ?
          event.which == 44 || // ,
          event.which == 46 // .
          //event.which == 127 // Delete
        ) {

      // Create regex pattern to format words in textentry into keywords
      // These keywords should be in their unmodified form (lowercase, unpluralized, removes punctuation)
      var pattern2 = /(\w+)/g;
      var str = $("#textentry").val();
      var match;
      var keywords = [];
      while ((match = pattern2.exec(str)) != null) {
        var lowercase_match = match[0].toLowerCase();
        if (common_english_words.indexOf(lowercase_match) == -1) {
          keywords.push(lowercase_match);
        }
      }

      // Regex pattern to check keywords with old comments
      {% for comment in oldComments %}
        var pattern3 = new RegExp('\\b' + '{{comment.text}}' + '(?:es|s)?\\b', 'gi');
        while ((match = pattern3.exec(str)) != null) {

        }
      {% endfor %}

      // Get all words in text entry
      var words_in_textentry = $("#textentry").val().split(' ');

      // Format words (remove pluralization, make lowercase, remove extra punctuation)
      // Remove all blacklisted words (common English words)
      var keywords = [];
      for (var i in words_in_textentry) {
        var lowercase_keyword = words_in_textentry[i].toLowerCase();

        if (common_english_words.indexOf(lowercase_keyword) == -1) {
          keywords.push(lowercase_keyword);
        }
      }*/

      /*if (keywords.length != 0) {
        // Find matching comments
        var matches = [];
        {% for comment in oldComments %}
          // To do comparisons, make comments and substrings lowercase
          var comment_text = '{{comment.text}}';
          var lowercase_comment = comment_text.toLowerCase();

          // Check to make sure all of the substrings are in the comment
          var match = true;
          for (var i in keywords) {
            var index = lowercase_comment.indexOf(keywords[i]);
            if (index == -1) {
              match = false;
            }
          }
          if (match == true) {
            matches.push('{{comment.text}}');
          }
        {% endfor %}
        if (matches.length != 0) {
          console.log(matches);
        }
      }
    }
  });*/

/////////////////////////////////////////////////////////////////////////////////
// Dropdown bar
/////////////////////////////////////////////////////////////////////////////////

  /*$("#comments-dropdown").hide();

  $("#textentry").keypress(function(event) {
    ///////////////////////////////////////////////
    // TODO: This needs to be changed!
    // Test whether user has finished typing a word
    ///////////////////////////////////////////////
    if (
          //event.which == 8 || // Backspace
          event.which == 32 || // Space
          event.which == 33 || // ?
          event.which == 44 || // ,
          event.which == 46 // .
          //event.which == 127 // Delete
        ) {
      // Get all words in text entry
      var words_in_textentry = $("#textentry").val().split(' ');

      // Remove all blacklisted words (common English words)
      var keywords = [];
      for (var i in words_in_textentry) {
        if (common_english_words.indexOf(words_in_textentry[i]) == -1) {
          keywords.push(words_in_textentry[i]);
        }
      }
      if (keywords.length == 0) {
        $("#comments-dropdown").hide();
        return;
      }

      // Generate comment snippets
      var comment_snippets = [];
      var full_comments = [];
      {% for comment in oldComments %}
        var relevant_snippet = generate_relevant_snippet('{{comment.text}}', keywords);
        if (relevant_snippet != null) {
          comment_snippets.push(relevant_snippet);
          full_comments.push('{{comment}}');
        }
      {% endfor %}

      // Add snippets to select
      $("#comments-dropdown").show();
      $("#comments-dropdown select").empty();
      $("#comments-dropdown select").append("<option value='default'>These comments might be similar:</option>");
      for (var i in comment_snippets) {
        $("#comments-dropdown select").append("<option id='dropdownoption"+i+"'>" + comment_snippets[i] + "</option>");
        $("#dropdownoption"+i).val(full_comments[i]);
      }
    }
  });

  // When a student clicks on a comment snippet from the dropdown, the full comment appears in the textarea.
  $("#comments-dropdown select").change(function() {
    if ($("#comments-dropdown select").val() == 'default') {
      $("#textentry").val('');
      $("#comments-dropdown").hide();
      $("#textentry").focus();
    }
    else {
      $("#textentry").val($("#comments-dropdown select").val());
    }
  });*/

</script>

<div class="comment new-comment" title="Add a comment">
  <div class="comment-header">
    <span class="comment-line-numbers">
    {{ start }}
    {% if end != start %} - {{ end }}
    {% endif %}
    </span>
    <span class="comment-snippet">
    {{ snippet }}
    </span>
  </div>
  <div class="comment-form">
    <form id="new-comment-form" 
      action="{% url 'review.views.new_comment' %}" method="post">
      {% csrf_token %}
      {{ form.text }}
      {{ form.start }}
      {{ form.end }}
      {{ form.chunk }}
      <button type="submit">Save</button>
      <button id="cancel-button" type="button">Cancel</button>
    </form>
  </div>
</div>
